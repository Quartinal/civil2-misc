{
  "version": 3,
  "sources": ["../wrapper/session.ts"],
  "sourcesContent": ["import { StrShuffler } from \"./shuffler.ts\";\nimport { buildProxyHref } from \"./url.ts\";\n\nconst SESSION_KEY = \"session-string\";\n\nasync function fetchText(url: string) {\n  const res = await fetch(url);\n  if (!res.ok) throw new Error(`http ${res.status} from ${url}`);\n  return res.text();\n}\n\nasync function sessionExists(serverBase: string, id: string) {\n  const text = await fetchText(\n    `${serverBase}/sessionexists?id=${encodeURIComponent(id)}`,\n  );\n  return text === \"exists\";\n}\n\nasync function newSession(serverBase: string) {\n  return fetchText(`${serverBase}/newsession`);\n}\n\nasync function fetchShuffleDict(serverBase: string, id: string) {\n  const text = await fetchText(\n    `${serverBase}/api/shuffleDict?id=${encodeURIComponent(id)}`,\n  );\n  return JSON.parse(text) as string;\n}\n\nasync function getOrCreateSession(serverBase: string) {\n  const stored = localStorage.getItem(SESSION_KEY);\n  if (stored && (await sessionExists(serverBase, stored))) return stored;\n  const id = await newSession(serverBase);\n  localStorage.setItem(SESSION_KEY, id);\n  return id;\n}\n\nexport async function encode(\n  baseUrl: string,\n  serverBase: string,\n  prefix?: string,\n) {\n  const sessionId = await getOrCreateSession(serverBase);\n  const dict = await fetchShuffleDict(serverBase, sessionId);\n  const shuffler = StrShuffler.fromDictionary(dict);\n  const href = buildProxyHref(baseUrl, sessionId, shuffler, prefix);\n  shuffler.free();\n  return href;\n}\n"],
  "mappings": "gFAGA,IAAMA,EAAc,iBAEpB,eAAeC,EAAUC,EAAa,CACpC,IAAMC,EAAM,MAAM,MAAMD,CAAG,EAC3B,GAAI,CAACC,EAAI,GAAI,MAAM,IAAI,MAAM,QAAQA,EAAI,MAAM,SAASD,CAAG,EAAE,EAC7D,OAAOC,EAAI,KAAK,CAClB,CAEA,eAAeC,EAAcC,EAAoBC,EAAY,CAI3D,OAHa,MAAML,EACjB,GAAGI,CAAU,qBAAqB,mBAAmBC,CAAE,CAAC,EAC1D,IACgB,QAClB,CAEA,eAAeC,EAAWF,EAAoB,CAC5C,OAAOJ,EAAU,GAAGI,CAAU,aAAa,CAC7C,CAEA,eAAeG,EAAiBH,EAAoBC,EAAY,CAC9D,IAAMG,EAAO,MAAMR,EACjB,GAAGI,CAAU,uBAAuB,mBAAmBC,CAAE,CAAC,EAC5D,EACA,OAAO,KAAK,MAAMG,CAAI,CACxB,CAEA,eAAeC,EAAmBL,EAAoB,CACpD,IAAMM,EAAS,aAAa,QAAQX,CAAW,EAC/C,GAAIW,GAAW,MAAMP,EAAcC,EAAYM,CAAM,EAAI,OAAOA,EAChE,IAAML,EAAK,MAAMC,EAAWF,CAAU,EACtC,oBAAa,QAAQL,EAAaM,CAAE,EAC7BA,CACT,CAEA,eAAsBM,EACpBC,EACAR,EACAS,EACA,CACA,IAAMC,EAAY,MAAML,EAAmBL,CAAU,EAC/CW,EAAO,MAAMR,EAAiBH,EAAYU,CAAS,EACnDE,EAAWC,EAAY,eAAeF,CAAI,EAC1CG,EAAOC,EAAeP,EAASE,EAAWE,EAAUH,CAAM,EAChE,OAAAG,EAAS,KAAK,EACPE,CACT",
  "names": ["SESSION_KEY", "fetchText", "url", "res", "sessionExists", "serverBase", "id", "newSession", "fetchShuffleDict", "text", "getOrCreateSession", "stored", "encode", "baseUrl", "prefix", "sessionId", "dict", "shuffler", "StrShuffler", "href", "buildProxyHref"]
}
